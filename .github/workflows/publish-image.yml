# SPDX-FileCopyrightText: 2025 Weibo, Inc.
#
# SPDX-License-Identifier: Apache-2.0

name: Publish Image

on:
  pull_request:
    types: [closed]
  workflow_dispatch:

env:
  GIT_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha || 'main' }}
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

concurrency:
  group: publish-image
  cancel-in-progress: false

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: >
      ( github.event_name == 'pull_request' &&
        github.event.pull_request.base.ref == 'main' &&
        github.event.pull_request.merged == true &&
        contains(github.event.pull_request.title, 'Changeset version bump') ) ||
      github.event_name == 'workflow_dispatch'

    outputs:
      new_version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code (full history for version detection)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Get version from docker-compose (and bump patch)
        id: get_version
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f docker-compose.yml ]; then
            echo "Error: docker-compose.yml not found"
            exit 1
          fi

          LINE=$(grep -E 'ghcr.io/wecode-ai/wegent-backend:[0-9]+\.[0-9]+\.[0-9]+' docker-compose.yml | head -1 || true)
          if [ -z "$LINE" ]; then
            echo "Error: Could not find backend image line in docker-compose.yml"
            exit 1
          fi

          VERSION=$(echo "$LINE" | sed -E 's/.*ghcr.io\/wecode-ai\/wegent-backend:([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from docker-compose.yml"
            exit 1
          fi

          echo "Current version: $VERSION"

          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          if [ ${#VERSION_PARTS[@]} -ne 3 ]; then
            echo "Error: Invalid version format '$VERSION'. Expected MAJOR.MINOR.PATCH"
            exit 1
          fi

          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          if ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "Error: PATCH '$PATCH' is not a number"
            exit 1
          fi

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

  determine-changes:
    runs-on: ubuntu-latest
    needs: prepare-release
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      chat_shell: ${{ steps.filter.outputs.chat_shell }}
      executor: ${{ steps.filter.outputs.executor }}
      executor_manager: ${{ steps.filter.outputs.executor_manager }}
      frontend: ${{ steps.filter.outputs.frontend }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Select comparison range for change detection
        id: compare
        shell: bash
        run: |
          set -euo pipefail

          # Ensure latest tags are available before describing release history
          git fetch --tags --force

          HEAD_REF=$(git rev-parse HEAD)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)

          if [ -n "${LAST_TAG}" ]; then
            BASE_REF="${LAST_TAG}"
            echo "Using last release tag ${LAST_TAG} as base."
          else
            if git rev-parse "${HEAD_REF}^" >/dev/null 2>&1; then
              BASE_REF=$(git rev-parse "${HEAD_REF}^")
              echo "No release tag found; using previous commit ${BASE_REF}."
            else
              BASE_REF="${HEAD_REF}"
              echo "Only one commit present; using HEAD for both base and head."
            fi
          fi

          echo "base_ref=${BASE_REF}" >> "$GITHUB_OUTPUT"
          echo "head_ref=${HEAD_REF}" >> "$GITHUB_OUTPUT"

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3.0.2
        with:
          base: ${{ steps.compare.outputs.base_ref }}
          ref: ${{ steps.compare.outputs.head_ref }}
          filters: |
            backend:
              - 'backend/**'
              - 'docker/backend/**'

            chat_shell:
              - 'chat_shell/**'
              - 'docker/chat_shell/**'

            executor:
              - 'executor/**'
              - 'docker/executor/**'

            executor_manager:
              - 'executor_manager/**'
              - 'docker/executor_manager/**'

            frontend:
              - 'frontend/**'
              - 'docker/frontend/**'

  build-backend:
    needs: [prepare-release, determine-changes]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    if: needs.determine-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-backend:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-executor:
    needs: [prepare-release, determine-changes]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    if: needs.determine-changes.outputs.executor == 'true'

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push executor image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/executor/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-executor:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-executor:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-executor-manager:
    needs: [prepare-release, determine-changes]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    if: needs.determine-changes.outputs.executor_manager == 'true'

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push executor manager image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/executor_manager/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-executor-manager:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-executor-manager:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    needs: [prepare-release, determine-changes]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    if: needs.determine-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-web:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-chat-shell:
    needs: [prepare-release, determine-changes]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    if: needs.determine-changes.outputs.chat_shell == 'true'

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push chat shell image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/chat_shell/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-chat-shell:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-chat-shell:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release-tag:
    needs:
      - prepare-release
      - determine-changes
      - build-backend
      - build-chat-shell
      - build-executor
      - build-executor-manager
      - build-frontend
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: >
      always() &&
      needs.prepare-release.result == 'success' &&
      (
        (needs.determine-changes.outputs.backend == 'true' && needs.build-backend.result == 'success') ||
        (needs.determine-changes.outputs.chat_shell == 'true' && needs.build-chat-shell.result == 'success') ||
        (needs.determine-changes.outputs.executor == 'true' && needs.build-executor.result == 'success') ||
        (needs.determine-changes.outputs.executor_manager == 'true' && needs.build-executor-manager.result == 'success') ||
        (needs.determine-changes.outputs.frontend == 'true' && needs.build-frontend.result == 'success')
      )

    steps:
      - name: Checkout code (full history + tags)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare-release.outputs.new_version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --tags --force

          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists, skipping tag creation"
          else
            git tag -a "v${VERSION}" -m "Release version ${VERSION}"
            git push origin "v${VERSION}"
            echo "Created and pushed tag v${VERSION}"
          fi

      - name: Generate Release Notes
        id: release-notes
        uses: actions/github-script@v7
        env:
          TAG: v${{ needs.prepare-release.outputs.new_version }}
        with:
          script: |
            const tag = process.env.TAG;
            if (!tag) {
              core.setFailed('TAG env is missing; cannot generate release notes.');
              return;
            }

            try {
              const { data } = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
              });
              core.setOutput("tag", tag);
              core.setOutput("body", data.body || '');
            } catch (error) {
              core.setFailed(`Failed to generate release notes: ${error.message}`);
            }

      - name: Create GitHub Release
        if: steps.release-notes.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-notes.outputs.tag }}
          name: Release ${{ steps.release-notes.outputs.tag }}
          body: ${{ steps.release-notes.outputs.body }}
          draft: false
          prerelease: false

  update-docker-compose:
    needs:
      - prepare-release
      - determine-changes
      - build-backend
      - build-chat-shell
      - build-executor
      - build-executor-manager
      - build-frontend
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: >
      always() &&
      needs.prepare-release.result == 'success' &&
      (
        (needs.determine-changes.outputs.backend == 'true' && needs.build-backend.result == 'success') ||
        (needs.determine-changes.outputs.chat_shell == 'true' && needs.build-chat-shell.result == 'success') ||
        (needs.determine-changes.outputs.executor == 'true' && needs.build-executor.result == 'success') ||
        (needs.determine-changes.outputs.executor_manager == 'true' && needs.build-executor-manager.result == 'success') ||
        (needs.determine-changes.outputs.frontend == 'true' && needs.build-frontend.result == 'success')
      )

    steps:
      - name: Checkout code from release ref (avoid drift vs main)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update docker-compose.yml versions (only for changed components)
        shell: bash
        env:
          VERSION: ${{ needs.prepare-release.outputs.new_version }}
          CHANGED_BACKEND: ${{ needs.determine-changes.outputs.backend }}
          CHANGED_CHAT_SHELL: ${{ needs.determine-changes.outputs.chat_shell }}
          CHANGED_EXECUTOR: ${{ needs.determine-changes.outputs.executor }}
          CHANGED_EXECUTOR_MANAGER: ${{ needs.determine-changes.outputs.executor_manager }}
          CHANGED_FRONTEND: ${{ needs.determine-changes.outputs.frontend }}
        run: |
          set -euo pipefail

          if [ ! -f docker-compose.yml ]; then
            echo "Error: docker-compose.yml not found"
            exit 1
          fi

          if [ "${CHANGED_BACKEND}" = "true" ]; then
            echo "Updating backend image version to ${VERSION}"
            sed -i -E "s|(ghcr.io/wecode-ai/wegent-backend:)[0-9]+\.[0-9]+\.[0-9]+|\1${VERSION}|g" docker-compose.yml
          else
            echo "Backend unchanged, skip updating backend image tag"
          fi

          if [ "${CHANGED_CHAT_SHELL}" = "true" ]; then
            echo "Updating chat shell image version to ${VERSION}"
            sed -i -E "s|(ghcr.io/wecode-ai/wegent-chat-shell:)[0-9]+\.[0-9]+\.[0-9]+|\1${VERSION}|g" docker-compose.yml
          else
            echo "Chat shell unchanged, skip updating chat shell image tag"
          fi

          if [ "${CHANGED_EXECUTOR}" = "true" ]; then
            echo "Updating executor image version to ${VERSION}"
            sed -i -E "s|(ghcr.io/wecode-ai/wegent-executor:)[0-9]+\.[0-9]+\.[0-9]+|\1${VERSION}|g" docker-compose.yml
          else
            echo "Executor unchanged, skip updating executor image tag"
          fi

          if [ "${CHANGED_EXECUTOR_MANAGER}" = "true" ]; then
            echo "Updating executor manager image version to ${VERSION}"
            sed -i -E "s|(ghcr.io/wecode-ai/wegent-executor-manager:)[0-9]+\.[0-9]+\.[0-9]+|\1${VERSION}|g" docker-compose.yml
          else
            echo "Executor manager unchanged, skip updating executor manager image tag"
          fi

          if [ "${CHANGED_FRONTEND}" = "true" ]; then
            echo "Updating frontend image version to ${VERSION}"
            sed -i -E "s|(ghcr.io/wecode-ai/wegent-web:)[0-9]+\.[0-9]+\.[0-9]+|\1${VERSION}|g" docker-compose.yml
          else
            echo "Frontend unchanged, skip updating frontend image tag"
          fi

      - name: Create Pull Request for docker-compose bump
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update docker-compose.yml to version ${{ needs.prepare-release.outputs.new_version }}"
          branch: weagent/update-docker-compose-${{ needs.prepare-release.outputs.new_version }}
          delete-branch: true
          title: "chore: update docker-compose.yml to version ${{ needs.prepare-release.outputs.new_version }}"
          body: |
            This PR updates Docker image versions in docker-compose.yml to version ${{ needs.prepare-release.outputs.new_version }}.

            ## Changes
            The following images have been built and pushed to GHCR with version ${{ needs.prepare-release.outputs.new_version }} (only modules with changes were updated):

            - Backend image: `ghcr.io/wecode-ai/wegent-backend:${{ needs.prepare-release.outputs.new_version }}` (changed: ${{ needs.determine-changes.outputs.backend }})
            - Chat Shell image: `ghcr.io/wecode-ai/wegent-chat-shell:${{ needs.prepare-release.outputs.new_version }}` (changed: ${{ needs.determine-changes.outputs.chat_shell }})
            - Executor image: `ghcr.io/wecode-ai/wegent-executor:${{ needs.prepare-release.outputs.new_version }}` (changed: ${{ needs.determine-changes.outputs.executor }})
            - Executor Manager image: `ghcr.io/wecode-ai/wegent-executor-manager:${{ needs.prepare-release.outputs.new_version }}` (changed: ${{ needs.determine-changes.outputs.executor_manager }})
            - Frontend image: `ghcr.io/wecode-ai/wegent-web:${{ needs.prepare-release.outputs.new_version }}` (changed: ${{ needs.determine-changes.outputs.frontend }})

            ## Release Tag
            Git tag `v${{ needs.prepare-release.outputs.new_version }}` has been created and pushed (if at least one component changed).
